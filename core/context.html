<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Application Context API</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel2">
<li><a href="#_application_context_api">1. Application Context API</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect2">
<h3 id="_application_context_api"><a class="anchor" href="#_application_context_api"></a>1. Application Context API</h3>
<div class="paragraph">
<p>Rico provides an application context that can be used to hold attributes in a global and a per-thread context.
An attribute is defined as a key-value pair.
Both key and values are strings.
These pairs can be stored and read from the global context or the context of the current thread only.
All attributes describe metadata to help in debugging, maintaining and analysing an application.</p>
</div>
<div class="paragraph">
<p>The interface <code>dev.rico.core.context.RicoApplicationContext</code> defines the application context in Rico and provides several methods to store and receive context based information.
Depending on your environment Rico provides different ways to obtain a <code>RicoApplicationContext</code> instance.</p>
</div>
<div class="paragraph">
<p>The following sample shows how values can be stored:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">final</span> RicoApplicationContext ricoContext = ... <i class="conum" data-value="1"></i><b>(1)</b>

ricoContext.setGlobalAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">application.type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">microservice</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="2"></i><b>(2)</b>
ricoContext.setThreadLocalAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">thread.type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">background thread</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>depends on your environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>here an attribute is stored in the global context.
"application.type" is the name / key of the attribute and "microservice" is the value</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>here an attribute is stored in the context of the current thread.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When storing thread based context information you normally want to keep the information for a specific task only and the information will be invalid afterwards.
To do so the following pattern is quite helpful when defining attributes in the thread context:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">final</span> <span class="predefined-type">Result</span> callDatabase(<span class="directive">final</span> <span class="predefined-type">String</span> query) {
    <span class="directive">final</span> RicoApplicationContext ricoContext = ... <i class="conum" data-value="1"></i><b>(1)</b>
    final Assignment queryAttributeAssignment = ricoContext.setThreadLocalAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">db.query</span><span class="delimiter">&quot;</span></span>, query); <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="keyword">try</span> {
        <span class="keyword">return</span> db.call(query); <i class="conum" data-value="3"></i><b>(3)</b>
    } <span class="keyword">finally</span> {
        queryAttributeAssignment.unset(); <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>depends on your environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>here the attribute "db.query" is stored in the thread context.
The <code>Assignment</code> instance can be used to remove the added attribute from the context.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>While we call our database the context attribute "db.query" will remain set.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Once the database call has been executed we remove the attribute from the thread context by calling the <code>unset()</code> method.
This should always be done in a <code>finally</code> block since an exception my prevent this otherwise.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_benefits_of_the_application_context"><a class="anchor" href="#_benefits_of_the_application_context"></a>1.1. Benefits of the application context</h4>
<div class="paragraph">
<p>The application context in Rico is integrated in several libraries and features of Rico.
The remoting library of Rico automatically adds information to the context that can be helpful.
The metrics and logging libraries of Rico provide the possibility to enrich metrics and logging with context based attributes through the application context.
This allows you to easily assign all logging messages of a server to specific users and requests or to store the metrics of several microservices in the same Prometheus instance and query for a specific instance later.
More information can be found in the documentation of the metrics and logging API.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/context-in-log.svg" alt="context in log"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_api_on_the_client"><a class="anchor" href="#_using_the_api_on_the_client"></a>1.2. Using the API on the client</h4>
<div class="paragraph">
<p>In the Rico client API a <code>dev.rico.core.context.RicoApplicationContext</code> instance can be obtained by using by the following call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">final</span> RicoApplicationContext ricoContext = Client.getService(RicoApplicationContext.class);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_api_on_the_server"><a class="anchor" href="#_using_the_api_on_the_server"></a>1.3. Using the API on the server</h4>
<div class="paragraph">
<p>On JakartaEE and Spring you can inject a <code>dev.rico.core.context.RicoApplicationContext</code> instance in any managed bean.
The instance is always defined in the singleton / application scope.</p>
</div>
</div>
<div class="sect3">
<h4 id="_predefined_context_values"><a class="anchor" href="#_predefined_context_values"></a>1.4. Predefined Context values</h4>
<div class="paragraph">
<p>Rico already defines some context attributes by default.
The following table gives an overview of all the context attributes that are defined by default when using Rico.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Predefined context attributes</caption>
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 9.5238%;">
<col style="width: 9.5238%;">
<col style="width: 19.0476%;">
<col style="width: 47.6191%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">attribute name</th>
<th class="tableblock halign-center valign-top">type</th>
<th class="tableblock halign-center valign-top">availability</th>
<th class="tableblock halign-center valign-top">sample</th>
<th class="tableblock halign-left valign-top">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">application.name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">global</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">always</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">myApplication</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the application if defined in the configuration by the "application.name" property. Otherwise "UNKNOWN"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rico.version</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">global</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">always</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1.1.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The used version of Rico</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">system.os</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">global</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">always</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">mac</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the used operation system. "linux", "mac", "win" or "unknown"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.version</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">global</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">always</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">11.0.3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The version of the used Java runtime</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.vendor</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">global</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">always</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">AdoptOpenJDK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The vendor of the used Java runtime</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">system.hostName</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">global</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">always</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">my-macbook.karakun</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The host name of the system</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">system.canonicalHostName</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">global</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">always</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">my-macbook.karakun</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The canonical host name of the system</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">system.hostAddress</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">global</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">always</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">192.168.178.23</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The host address of the system</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">thread</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">thread</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">always</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">background-thread-2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the current thread. This is only supported for threads that are created by Rico</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uiToolkit</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">global</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">client</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">JavaFX toolkit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the used UI toolkit. This value is only defined when using the rico-client library.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">security.userName</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">global</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">client</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">admin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When using rico-security this value defines the name of the logged in user on the client</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">security.userName</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">thread</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">server</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">admin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When using rico-security this value defines the name of the logged in user for the current request on the server</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">remoting.controller</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">thread</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">server</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">WorkflowController</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the remoting controller when a controller action is executed on the server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">remoting.action</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">thread</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">server</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">saveUser</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the remoting controller action that is executed on the server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">http.session</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">thread</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">server</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1342424</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id of the http session on the server</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">http.clientSession</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">thread</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">server</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">749516</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id of the http client session on the server</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 2.1.0-SNAPSHOT<br>
Last updated 2021-06-25 06:18:42 UTC
</div>
</div>
<link rel="stylesheet" href="./coderay-asciidoctor.css">
</body>
</html>